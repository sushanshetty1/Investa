// ===================================================================
// SUPABASE DATABASE SCHEMA - Authentication & User Management
// ===================================================================
// This schema handles all authentication, user management, and related
// functionality for the Invista inventory management system.

generator supabaseClient {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  output          = "./generated/supabase"
}

datasource supabaseDb {
  provider = "postgresql"
  url      = env("SUPABASE_DATABASE_URL")
}

// ===================================================================
// AUTHENTICATION & USER MODELS
// ===================================================================

model User {
  id            String  @id @default(uuid())
  email         String  @unique
  emailVerified Boolean @default(false)

  // Profile Information
  firstName   String?
  lastName    String?
  displayName String?
  avatar      String?
  phone       String?

  // Authentication
  password         String? // For email/password auth
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Account Settings
  timezone String @default("UTC")
  language String @default("en")
  theme    String @default("system") // light, dark, system

  // Account Status
  isActive        Boolean @default(true)
  isVerified      Boolean @default(false)
  isSuspended     Boolean @default(false)
  suspendedReason String?

  // Security
  lastLoginAt      DateTime?
  lastLoginIp      String?
  failedLoginCount Int       @default(0)
  lockedUntil      DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userRoles       UserRole[]
  sessions        UserSession[]
  loginHistory    LoginHistory[]
  passwordResets  PasswordReset[]
  invitations     UserInvitation[]   @relation("InvitedBy")
  receivedInvites UserInvitation[]   @relation("InvitedUser")
  auditLogs       AuditLog[]
  preferences     UserPreference[]
  notifications   UserNotification[]
  apiKeys         ApiKey[]

  @@map("users")
}

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  displayName String
  description String?
  color       String? // For UI display

  // Permissions
  permissions Json // Store permissions as JSON

  // Hierarchy
  level    Int     @default(0) // 0 = lowest, higher numbers = more permissions
  isSystem Boolean @default(false) // System roles cannot be deleted

  // Status
  isActive Boolean @default(true)

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userRoles UserRole[]

  @@map("roles")
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  // Assignment Details
  assignedBy String?
  assignedAt DateTime  @default(now())
  expiresAt  DateTime?

  // Status
  isActive Boolean @default(true)

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// ===================================================================
// SESSION & SECURITY MODELS
// ===================================================================

model UserSession {
  id     String @id @default(uuid())
  userId String

  // Session Details
  token        String  @unique
  refreshToken String? @unique

  // Device & Location
  userAgent  String?
  ipAddress  String?
  deviceId   String?
  deviceType String? // mobile, desktop, tablet
  browser    String?
  location   String? // City, Country

  // Timing
  lastActivity DateTime @default(now())
  expiresAt    DateTime

  // Status
  isActive  Boolean   @default(true)
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
  revokedBy String?

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model LoginHistory {
  id     String @id @default(uuid())
  userId String

  // Login Details
  successful Boolean
  failReason String?

  // Device & Location
  ipAddress  String
  userAgent  String?
  location   String?
  deviceType String?

  // Timing
  attemptedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_history")
}

model PasswordReset {
  id     String @id @default(uuid())
  userId String

  // Reset Details
  token     String   @unique
  expiresAt DateTime

  // Status
  isUsed Boolean   @default(false)
  usedAt DateTime?

  // Security
  ipAddress String?
  userAgent String?

  // Metadata
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// ===================================================================
// INVITATION & ONBOARDING MODELS
// ===================================================================

model UserInvitation {
  id String @id @default(uuid())

  // Invitation Details
  email  String
  roleId String?
  token  String  @unique

  // Inviter Information
  invitedById   String
  invitedByName String

  // Recipient Information
  invitedUserId String? // Set when invitation is accepted

  // Message
  message String?

  // Status
  status InvitationStatus @default(PENDING)

  // Timing
  expiresAt  DateTime
  sentAt     DateTime?
  acceptedAt DateTime?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invitedBy   User  @relation("InvitedBy", fields: [invitedById], references: [id])
  invitedUser User? @relation("InvitedUser", fields: [invitedUserId], references: [id])

  @@map("user_invitations")
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

// ===================================================================
// PREFERENCES & SETTINGS MODELS
// ===================================================================

model UserPreference {
  id     String @id @default(uuid())
  userId String

  // Preference Details
  category String // dashboard, notifications, inventory, etc.
  key      String // specific setting name
  value    Json // flexible value storage

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category, key])
  @@map("user_preferences")
}

// ===================================================================
// NOTIFICATION MODELS
// ===================================================================

model UserNotification {
  id     String @id @default(uuid())
  userId String

  // Notification Content
  title    String
  message  String
  type     NotificationType
  category String? // inventory, orders, alerts, etc.
  priority NotificationPriority @default(MEDIUM)

  // Visual
  icon  String?
  color String?

  // Actions
  actionUrl  String?
  actionText String?

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Delivery
  channels    Json? // email, sms, push, in-app
  sentAt      DateTime?
  deliveredAt DateTime?

  // Metadata
  metadata Json? // Additional data

  // Timing
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notifications")
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  ALERT
  REMINDER
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ===================================================================
// AUDIT & LOGGING MODELS
// ===================================================================

model AuditLog {
  id String @id @default(uuid())

  // User Context
  userId    String?
  userEmail String? // Stored for reference even if user is deleted

  // Action Details
  action     String // CREATE, UPDATE, DELETE, LOGIN, etc.
  resource   String // users, roles, settings, etc.
  resourceId String? // ID of the affected resource

  // Changes
  oldValues Json? // Previous state
  newValues Json? // New state
  changes   Json? // Summary of what changed

  // Context
  ipAddress String?
  userAgent String?
  sessionId String?

  // Metadata
  metadata Json? // Additional context
  severity AuditSeverity @default(INFO)

  // Timing
  timestamp DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

enum AuditSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

// ===================================================================
// SYSTEM CONFIGURATION MODELS
// ===================================================================

model SystemSetting {
  id String @id @default(uuid())

  // Setting Details
  category String // auth, security, features, etc.
  key      String // specific setting name
  value    Json // flexible value storage

  // Metadata
  description String?
  isPublic    Boolean @default(false) // Can be read by frontend
  isSystem    Boolean @default(false) // Cannot be modified via UI

  // Validation
  dataType   String? // string, number, boolean, json
  validation Json? // Validation rules

  // Timing
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, key])
  @@map("system_settings")
}

// ===================================================================
// API & INTEGRATION MODELS
// ===================================================================

model ApiKey {
  id     String  @id @default(uuid())
  userId String? // Optional: for user-specific keys

  // Key Details
  name      String // Human-readable name
  keyHash   String @unique // Hashed version of the key
  keyPrefix String @unique // First 8 chars for identification

  // Permissions
  scopes Json // Array of allowed scopes/permissions

  // Usage
  lastUsedAt DateTime?
  usageCount Int       @default(0)

  // Limits
  rateLimit Int? // Requests per minute
  expiresAt DateTime?

  // Status
  isActive  Boolean   @default(true)
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
  revokedBy String?

  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}
